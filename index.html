<form id="myForm" enctype="multipart/form-data">
    <input type="text" name="Name" placeholder="Your Name" required />
    <input type="email" name="email" placeholder="Your Email" />
    <input type="text" name="phone" placeholder="Your Phone Number" />
    <input type="text" name="address" placeholder="Your Address" />
    <input type="text" name="Church" placeholder="Church You Attend (Enter N/A if you're unafiiliated)" />

    <label>Your Skills:</label>
    <div id="skill-container">
        <input type="text" id="skill-input" placeholder="Enter skill" />
        <button type="button" id="add-skill">Add Skill</button>
    </div>
    <ul id="skill-list">
        <!-- Dynamic skills will appear here -->
    </ul>

    <label>Availability:</label>
    <input type="checkbox" name="Availability" value="Sunday" /> Sunday
    <input type="checkbox" name="Availability" value="Monday" /> Monday
    <input type="checkbox" name="Availability" value="Tuesday" /> Tuesday
    <input type="checkbox" name="Availability" value="Wednesday" /> Wednesday
    <input type="checkbox" name="Availability" value="Thursday" /> Thursday
    <input type="checkbox" name="Availability" value="Friday" /> Friday
    <input type="checkbox" name="Availability" value="Saturday" /> Saturday

    <label for="photo">Upload Your Photo:</label>
    <input type="file" name="photo" id="photo" accept="image/*" required />

    <button type="submit">Submit</button>
    <p id="loading-message" style="display: none; color: blue;">Processing... Please wait.</p>

</form>


<script>
    document.getElementById('myForm').addEventListener('submit', async function (event) {
        event.preventDefault();

        const photoUrl = await storePhotoInS3()
        const formObject = getFormObject(event, photoUrl)
        await sendFormToProcessAPI(formObject)
    });

    document.getElementById('add-skill').addEventListener('click', function () {
        const skillInput = document.getElementById('skill-input');
        const skillValue = skillInput.value.trim();

        if (skillValue) {
            // Create new list item for the skill
            const skillItem = document.createElement('li');
            skillItem.textContent = skillValue;

            // Append the skill to the skill list
            document.getElementById('skill-list').appendChild(skillItem);

            // Clear the input field
            skillInput.value = '';
        } else {
            alert("Please enter a skill before adding.");
        }
    });

    function getFormObject(event, photoUrl) {
        const formData = new FormData(event.target);
        const formObject = {}

        const contactInfo = {
            email: formData.get('email'),
            phone: formData.get('phone'),
            address: formData.get('address')
        };

        formObject.Name = formData.get('Name')
        formObject.Skills = getSkillsList()
        formObject.Church = formData.get('Church')
        formObject.Availability = formData.getAll('Availability')//needs to be a str not an array
        formObject.ContactInfo = contactInfo
        formObject.PhotoURL = photoUrl

        return formObject
    }

    function getSkillsList() {
        const skills = [];
        document.querySelectorAll('#skill-list li').forEach(skill => {
            skills.push(skill.textContent.trim())
        });
        return skills
    }

    async function getPresignedResponse(file) {
        try {
            const presignedResponse = await fetch("https://dpb61izi2g.execute-api.us-east-2.amazonaws.com/getPresignedURL", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ fileName: file.name, fileType: file.type })
            });
            if (!presignedResponse.ok) {
                throw new Error("Failed to get pre-signed URL");
            }
            return await presignedResponse.json();
        }
        catch (e) {
            throw new Error(e)
        }
    }

    async function uploadPhotoToS3(file, uploadUrl) {     //Upload the file to S3 using the pre-signed URL
        try {
            const uploadResponse = await fetch(uploadUrl, {
                method: "PUT",
                body: file,
                headers: { "Content-Type": file.type }
            });

            if (!uploadResponse.ok) {
                throw new Error("File upload failed");
            }
        }
        catch (e) {
            throw new Error(e)
        }
    }

    async function sendFormToProcessAPI(formObject) {
        const processFormApiUrl = "https://dpb61izi2g.execute-api.us-east-2.amazonaws.com/processFormsToRDS";
        try {
            const apiResponse = await fetch(processFormApiUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",  // Set content type to JSON
                },
                body: JSON.stringify(formObject),  // Send the form data as a JSON object
            });

            if (apiResponse.ok) {
                alert("Form submitted successfully!");
            } 
            else {
                const responseText = await apiResponse.text();
                console.error("API call failed with status:", apiResponse.status);
                console.error("Response body:", responseText);
            }
        } 
        catch (error) {
            console.error("Submission error: ", error);
        }
    }

    async function storePhotoInS3() {
        const fileInput = document.getElementById('photo');
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const presignedResponse = await getPresignedResponse(file)
            await uploadPhotoToS3(file, presignedResponse.uploadUrl)
            return presignedResponse.fileUrl
        }
        else {
            throw new Error("Attached Photo Not Recognized.")
        }
    }
</script>